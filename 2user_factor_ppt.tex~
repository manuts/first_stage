\begin{figure}
 \centering
 \begin{tikzpicture}[thick,scale=0.4, every node/.style={scale=0.4}]
   \tikzstyle{snode}=[rectangle, draw, inner sep=4pt]
   \tikzstyle{cnode}=[rectangle, draw]
   \tikzstyle{vnode}=[circle, draw]
   
   % Writing comments
   \draw (0, 2.5) node{State nodes};
   \draw (-4, 2.5) node{User 1};
   \draw (4, 2.5) node{User 2};
   % state nodes
   \draw (0, 0) node[snode] (s1) {};
   \draw (0, 0.5) node {$p(y_1|x_1^{[1]}, x_1^{[2]})$};
   \draw (0, -0.3) node {$s_1$};
   \draw (0, -2) node[snode] (s2) {};
   \draw (0, -1.5) node{$p(y_2|x_2^{[1]}, x_2^{[2]})$};
   \draw (0, -2.3) node {$s_2$};
   \draw (0, -4) node{\textbullet};
   \draw (0, -6) node{\textbullet};
   \draw (0, -8) node{\textbullet};
   \draw (0, -10) node[snode] (sn1) {};
   \draw (0, -9.5) node{$p(y_{n-1}|x_{n-1}^{[1]}, x_{n-1}^{[2]})$};
   \draw (0, -10.3) node {$s_{n-1}$};
   \draw (0, -12) node[snode] (sn) {};
   \draw (0, -11.5) node{$p(y_n|x_n^{[1]}, x_n^{[2]})$};
   \draw (0, -12.3) node {$s_n$};
   % User 1 variable nodes
   \draw (-3, 0) node[vnode] (v11) {};
   \draw (-3, 0.5) node {$x_1^{[1]}$};
   \draw (-3, -2) node[vnode] (v12) {};
   \draw (-3, -1.5) node{$x_2^{[1]}$};
   \draw (-3, -4) node{\textbullet};
   \draw (-3, -6) node{\textbullet};
   \draw (-3, -8) node{\textbullet};
   \draw (-3, -10) node[vnode] (v1n1) {};
   \draw (-3, -9.5) node{$x_{n-1}^{[1]}$};
   \draw (-3, -12) node[vnode] (v1n) {};
   \draw (-3, -11.5) node{$x_n^{[1]}$};
   % User 2 variable nodes
   \draw (3, 0) node[vnode] (v21) {};
   \draw (3, 0.5) node {$x_1^{[2]}$};
   \draw (3, -2) node[vnode] (v22) {};
   \draw (3, -1.5) node{$x_2^{[2]}$};
   \draw (3, -4) node{\textbullet};
   \draw (3, -6) node{\textbullet};
   \draw (3, -8) node{\textbullet};
   \draw (3, -10) node[vnode] (v2n1) {};
   \draw (3, -9.5) node{$x_{n-1}^{[2]}$};
   \draw (3, -12) node[vnode] (v2n) {};
   \draw (3, -11.5) node{$x_n^{[2]}$};
   % User 1 check nodes
   \draw (-5, 1) node[cnode] (c11) {};
   \draw (-5, 1.5) node{$f_1^{[1]}$};
   \draw (-5, -1) node[cnode] (c12) {};
   \draw (-5, -0.5) node{$f_2^{[1]}$};
   \draw (-5, -3) node[cnode] (c13) {};
   \draw (-5, -2.5) node{$f_3^{[1]}$};
   \draw (-5, -5) node{\textbullet};
   \draw (-5, -7) node{\textbullet};
   \draw (-5, -9) node[cnode] (c1n2) {};
   \draw (-5, -8.5) node{$f_{n-2}^{[1]}$};
   \draw (-5, -11) node[cnode] (c1n1) {};
   \draw (-5, -10.5) node{$f_{n-1}^{[1]}$};
   \draw (-5, -13) node[cnode] (c1n) {};
   \draw (-5, -12.5) node{$f_n^{[1]}$};
   % User 2 check nodes
   \draw (5, 1) node[cnode] (c21) {};
   \draw (5, 1.5) node{$f_1^{[2]}$};
   \draw (5, -1) node[cnode] (c22) {};
   \draw (5, -0.5) node{$f_2^{[2]}$};
   \draw (5, -3) node[cnode] (c23) {};
   \draw (5, -2.5) node{$f_3^{[2]}$};
   \draw (5, -5) node{\textbullet};
   \draw (5, -7) node{\textbullet};
   \draw (5, -9) node[cnode] (c2n2) {};
   \draw (5, -8.5) node{$f_{n-2}^{[2]}$};
   \draw (5, -11) node[cnode] (c2n1) {};
   \draw (5, -10.5) node{$f_{n-1}^{[2]}$};
   \draw (5, -13) node[cnode] (c2n) {};
   \draw (5, -12.5) node{$f_n^{[2]}$};
   
   % Boxing
   \draw[red,thick,dotted] ($(c11.north west)+(-1,1)$)  rectangle ($(v1n.south east)+(1,-2)$);
   \draw[blue,thick,dotted] ($(c21.north east)+(1,1)$)  rectangle ($(v2n.south west)+(-1,-2)$);
   
   % State user 1 path
   \draw (v11) -- (s1);
   \draw (v12) -- (s2);
   \draw (v1n1) -- (sn1);
   \draw (v1n) -- (sn);
   % State user 2 path
   \draw (v21) -- (s1);
   \draw (v22) -- (s2);
   \draw (v2n1) -- (sn1);
   \draw (v2n) -- (sn);
   
   %user 1 upper connections
   \draw (v11) -- (c11);
   \draw (v12) -- (c11);
   \draw (v11) -- (c12);
   \draw (v12) -- (c13);
   \draw (v12) -- (c12);
   %user 1 lower connections
   \draw (v1n) -- (c1n);
   \draw (v1n1) -- (c1n);
   \draw (v1n) -- (c1n1);
   \draw (v1n1) -- (c1n2);
   \draw (v1n1) -- (c1n1);
   %user 2 upper connections
   \draw (v21) -- (c21);
   \draw (v22) -- (c21);
   \draw (v21) -- (c22);
   \draw (v22) -- (c23);
   \draw (v22) -- (c22);
   %user 2 lower connections
   \draw (v2n) -- (c2n);
   \draw (v2n1) -- (c2n);
   \draw (v2n) -- (c2n1);
   \draw (v2n1) -- (c2n2);
   \draw (v2n1) -- (c2n1);
 \end{tikzpicture}
 \caption{Factor graph for joint decoding of 2 users} \label{fig:2users_factor}
\end{figure}